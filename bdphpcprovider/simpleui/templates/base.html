<!DOCTYPE html>
{% load staticfiles %}
<html lang="en">
<head>
<meta charset="utf8">

<title>Bioscience Data Platform: TARDIS In The Cloud</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">
<style type="text/css">body{padding-top:10px;padding-bottom:40px}</style>
<link rel="stylesheet" type="text/css" href="{% static "bootstrap/css/bootstrap.min.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "bootstrap/css/bootstrap.min.theme.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "bootstrap/css/bootstrap-responsive.css" %}">
<link rel="stylesheet" type="text/css" href="{% static "simpleui/css/default.css" %}">
<link href="{% static "footable/footable.core.css" %}" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="{% static "font-awesome/css/font-awesome.css" %}"/>

<style>
    .modal-backdrop {background-color: #DCDCDC;}
    .body {margin-left: 0}
</style>

<script>

function closeDialog () {
    $('#createModal').modal('hide');
};
/**
$( "#id_presets" ).change(function() {
  alert( "Handler for .change() called." );
});
**/


function addPreset(form_id, directive_name){
    bootbox.prompt("Enter name for the new preset", function(result) {
        var result =  $.trim(result);
        if(result) {
            var dictionary = retrieveFormElementsValues(form_id, result)
            var request = $.ajax({
                            type: "POST",
                            url: "/coreapi/preset/",
                            data: {name: result, data: dictionary, directive: directive_name},
                            dataType: "json"
                            })
            request.done(function() {
                $("#id_presets").append('<option value='+result+'>'+result+'</option>');
                $("#id_presets").val(result);
                alert('Created');
                });
            request.fail(function(jqXHR) {
                alert(jqXHR.responseText);
                });
        }
    });
}


function deletePreset(form_id){
    var form =  '#' + form_id;
    var selected_item = $(form + " #id_presets option:selected").val();
    bootbox.confirm("Are you sure you want to delete preset '" + selected_item + "'?", function(result) {
        if (result){
            $.ajax({
                cache: false,
                url : '/coreapi/preset/?name='+selected_item,
                type : 'GET',
                dataType : 'json',
                success : function (data){
                            var id = data.id;
                            $.ajax({
                                url : '/coreapi/preset/' + id,
                                type : 'DELETE',
                                dataType : 'json',
                                success : function (){
                                            alert("deleted");
                                            $(form + " #id_presets option[value='" + selected_item + "']").remove();
                                            resetPreset(form_id);
                                }
                            });
                }
            });
        }
    });
}


function updatePreset(form_id, directive_name){
    var form =  '#' + form_id;
    selected_item = $(form + " #id_presets option:selected").val();
    $.ajax({
        cache: false,
        url : '/coreapi/preset/?name='+selected_item,
        type : 'GET',
        dataType : 'json',
        success : function (data){
                    var id = data.id;
                    var dictionary = retrieveFormElementsValues(form_id, '');
                    $.ajax({
                        url : '/coreapi/preset/' + id,
                        type : 'PUT',
                        data: {name: selected_item, data: dictionary, directive: directive_name},
                        dataType : 'json',
                        success : function (){
                                    alert("updated");
                        }
                    });
        }
    });
}


function resetPreset(form_id){
    var dictionary= {};
    var form = '#' + form_id;
    var selected_item = $.trim($("form #id_presets option:selected").val());
    $.ajax({
        cache: false,
        url : '/coreapi/preset/?name='+selected_item,
        type : 'GET',
        dataType : 'json',
        success : function (data)
        {
            $.each(data.parameters, function(i, item) {
                dictionary[i] = item
            });
            replaceFormElementsValues(form_id, dictionary)
        }
    });
}



function replaceFormElementsValues(form_id, dictionary){
    var elem = document.getElementById(form_id).elements;
    for(var i = 0; i < elem.length; i++){
        if (elem[i].name != 'preset_name' && elem[i].name.length > 0 && elem[i].name in dictionary){
            if (elem[i].type === 'checkbox'){
                if ((dictionary[elem[i].name]).toLowerCase() === 'on')
                    $('input').filter(':checkbox').attr('checked', true);
                else
                    $('input').filter(':checkbox').attr('checked', false);
            }
            else
                (document.getElementsByName(elem[i].name)[0]).value = dictionary[elem[i].name];
        }
    }
}

function retrieveFormElementsValues(form_id, preset_name){
    var form_content = ''
    var trimmed_preset_name =  $.trim(preset_name);
    var elem = document.getElementById(form_id).elements;
    for(var i = 0; i < elem.length; i++){
        if (elem[i].name == 'preset_name' && trimmed_preset_name)
            elem[i].value = trimmed_preset_name;
        if (elem[i].name.length > 0){
            var value = elem[i].value.replace(/\"/g, '\\\"');
            if (elem[i].type === 'checkbox'){
                if((document.getElementsByName(elem[i].name)[0]).checked)
                    value = "on"
                else
                    value = "off"
            }
            form_content += '"' + elem[i].name + '" : "' + value + '",';
        }
    }
    form_content = form_content.substr(0, form_content.length-1)
    var dictionary_string = "{" + form_content + "}"
    return dictionary_string
}



function submitForm(description, form_id) {
    var form = '#' + form_id;
    var operation = $(form + ' #id_operation');
    operation.val(description);
    form.validate();
    if (form.valid()){
        form.submit()
    }
    formreset()
}

function updatePlatform(parameters, platform_type) {
    $('form[id*="_form_update"]').hide();
    formreset()
    if (platform_type == 'csrack' || platform_type == 'nectar'){
        platform_type = 'cloud'
    }
    else if (platform_type == 'nci'){
        platform_type = 'cluster'
    }
    form_id = '#' + platform_type + '_form_update';
    $(form_id).show();
    $('form #id_platform_type').attr("disabled", "disabled")
    var current_params = parameters.replace(/[\]\(\)\[']/g, '');
    var array_params = current_params.split(',');
    for (var i=0;i<array_params.length;i++)
    {
        key = array_params[i].replace(/^[ \t]+|[ \t]+$./, '');
        value = array_params[++i].replace(/^[ \t]+|[ \t]+$./, '');
        param_id =   '#id_' + key
        $('form '+ param_id).val(value)
    };
    current_platform_name =  $('form #id_platform_name').val();
    $('form #id_filter').val(current_platform_name);
}

//consider merging the ff method with updatePlatform
function deletePlatform(parameters, platform_type) {
    $('form[id*="_form_delete"]').hide();
    fieldReadonly()
    if (platform_type == 'csrack' || platform_type == 'nectar'){
        platform_type = 'cloud'
    }
    else if (platform_type == 'nci'){
        platform_type = 'cluster'
    }
    form_id = '#' + platform_type + '_form_delete'
    $(form_id).show();
    var current_params = parameters.replace(/[\]\(\)\[']/g, '');
    var array_params = current_params.split(',');
    for (var i=0;i<array_params.length;i++)
    {
        key = array_params[i].replace(/^[ \t]+|[ \t]+$./, '');
        value = array_params[++i].replace(/^[ \t]+|[ \t]+$./, '');
        if (key=='password'){
            value = '--------'
        }
        param_id =   '#id_' + key
        $('form '+ param_id).val(value)
        //$('form '+ param_id).attr('readonly', true);
    };
}

function fieldReadonly(){
    var form =  $(this).closest('form').attr("id");
    $("form input[id][type='text']").attr("readonly", "readonly")
    $("form input[id][type='password']").attr("readonly", "readonly")
    $("form select[id]").attr("disabled", "disabled")
}

function formreset(){
    var form =  $(this).closest('form').attr("id");
    $("form input[id][type='text']").removeAttr("readonly");
    $("form input[id][type='password']").removeAttr("readonly");
    $("form input[id][type='text']").val("");
    $("form input[id][type='password']").val("");
    $("form select[id]").removeAttr("disabled");
    $("form select[id]").val($("form select[id] option:first").val());

 }



</script>

    <script type="text/javascript" src="{% static 'bootstrap/js/lib/jquery-1.8.3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap/js/lib/jquery.validate.js' %}"></script>
    <script type="text/javascript" src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'footable/footable.js' %}" type="text/javascript"></script>
    <script type="text/javascript" src="{% static 'bootstrap/js/lib/bootbox.min.js' %}"></script>
{% block head %}
{% endblock head %}
</head>


    <body>
        <div class="navbar navbar-fixed-top">
          <div class="navbar-inner">
            <div class="container-fluid">
              <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </a>

              <span class="brand"><a href="/">BDPHPC Beta</a></span>

              <div class="nav-collapse">
                <ul class="nav">
                    {% if not user.is_authenticated %}
                    <li><a  href="{% url login %}">login</a></li>
                    {% else %}
                    <li><a  href="{% url logout %}">logout</a></li>
                    <li><a  href="{% url makedirective 0 %}">Create Job</a></li>
                    <li><a  href="{% url hrmcjob-list %}">Jobs</a></li>
                    {% if user.is_superuser %}
                     <li><a  href="/admin">Admin</a></li>
                     {%endif %}
                    <li><a href="{% url computation-platform-settings %}">Settings</a></li>
                  <!-- <p class="navbar-text pull-right">
                       <a href="" class="navbar-link">Settings</a>
                   </p> -->
                    {% endif %}
                </ul>
                <ul class="login-nav nav pull-right"></ul>
              </div><!--/.nav-collapse -->
            </div>
          </div>
        </div>

        {% if messages %}
        <div class="row-fluid">
            {% for message in messages %}
            {% if message.tags %} <div class="span10 offset1 alert alert-{{ message.tags}}">
            {% else %} <div>
            {% endif %}{{message}} </div>
            {% endfor %}
        </div>
            {% endif %}

               {% block content %}


         {% endblock %}
    <hr>
        <footer>
            <div class="container">
            <div class="row-fluid">
            <div class=""><img src="http://nectar.org.au/sites/default/files/logo-small.png">
                <small><p>The Bioscience Data Platform acknowledges funding from the <a href="http://www.nectar.org.au">NeCTAR project</a>.</p></small></div>
            </div>
        </div>
        </footer>
    </div>
</div>
    <script>$(function() {
    $('button').tooltip();
});</script>
</body>
</html>

